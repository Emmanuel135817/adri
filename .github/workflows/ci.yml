name: CI

on:
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ['3.10', '3.11', '3.12']

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Needed for setuptools_scm

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .[dev,test]

    # Temporarily disabled to focus on test discovery debugging
    # - name: Run pre-commit checks
    #   run: |
    #     pre-commit run --all-files

    - name: Run tests with pytest
      run: |
        python -c "import os; os.makedirs('tests/coverage', exist_ok=True)"
        echo "üîç Validating test discovery in CI environment..."

        # First, validate test discovery
        TEST_COUNT=$(pytest --collect-only -q | grep "test session starts" -A 1000 | tail -1 | grep -o '[0-9]\+ tests collected' | grep -o '[0-9]\+' || echo "0")
        echo "üìä Tests discovered: $TEST_COUNT"

        # Ensure we find the expected number of tests (should be 863)
        if [ "$TEST_COUNT" -lt 800 ]; then
          echo "‚ùå CRITICAL: Only found $TEST_COUNT tests, expected ~863"
          echo "üîç Debugging test discovery..."

          # Show working directory and Python path
          echo "Working directory: $(pwd)"
          echo "Python path: $PYTHONPATH"
          ls -la tests/

          # Show what pytest sees
          echo "Pytest test discovery:"
          pytest --collect-only -q | head -10
          pytest --collect-only -q | tail -5

          # Check what's actually in tests/unit/
          echo "Contents of tests/unit/:"
          ls -la tests/unit/
          echo "Searching for test files in tests/unit/:"
          find tests/unit/ -name "test_*.py" | head -10

          # Try different pytest invocation patterns
          echo "Trying different pytest patterns..."
          pytest tests/unit/ --collect-only -q | tail -3
          pytest tests/ --collect-only -q | tail -3

          exit 1
        fi

        echo "‚úÖ Test discovery validation passed ($TEST_COUNT tests found)"

        # Run the actual tests with proper coverage
        pytest --cov-fail-under=40

    - name: Upload coverage to Codecov
      if: matrix.os == 'ubuntu-latest' && matrix.python-version == '3.11'
      uses: codecov/codecov-action@v3
      with:
        file: ./tests/coverage/coverage.xml
        fail_ci_if_error: false

  security:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install security tools
      run: |
        python -m pip install --upgrade "pip>=25.3" || python -m pip install --upgrade "pip!=25.2"
        pip install -e .[security]

    - name: Run Bandit security scan
      run: |
        mkdir -p tests/security
        bandit -r src/ -f json -o tests/security/bandit-report.json --skip B110
        bandit -r src/ --skip B110

    - name: Run Safety scan
      run: |
        safety check --json || echo "Safety scan completed with warnings"

    - name: Run pip-audit
      run: |
        pip-audit || echo "pip-audit completed with warnings (known pip build tool vulnerability)"

  build-test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Needed for setuptools_scm

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install build tools
      run: |
        python -m pip install --upgrade pip
        pip install build twine setuptools_scm

    - name: Test setuptools_scm version detection
      run: |
        python -c "from setuptools_scm import get_version; print(f'Version: {get_version()}')"

    - name: Build package
      run: |
        python -m build

    - name: Check package
      run: |
        twine check dist/*

    - name: Test installation
      run: |
        pip install dist/*.whl
        adri --version
        python -c "import adri; print(f'ADRI version: {adri.__version__}')"

    # Skip artifact upload under act (local) - fails due to missing node in runner
    - name: Upload build artifacts
      if: ${{ !env.ACT }}
      uses: actions/upload-artifact@v4
      with:
        name: adri-build-3.11
        path: dist/

  validate-root-structure:
    runs-on: ubuntu-latest
    needs: [test, security, build-test]
    if: always()  # Run even if other jobs had issues

    steps:
    - uses: actions/checkout@v4

    - name: Clean up temporary CI artifacts before validation
      run: |
        echo "üßπ Cleaning up temporary CI artifacts in validation environment..."

        # Remove all possible temporary artifacts that might exist
        rm -rf coverage.* .coverage* htmlcov/ .pytest_cache/ .benchmarks/
        rm -rf build/ dist/ *.egg-info/ .tox/ .mypy_cache/ .hypothesis/
        rm -rf bandit-report.* *.tmp *.temp pip-*.log
        rm -rf __pycache__/ .DS_Store Thumbs.db

        echo "‚úÖ Cleanup completed in validation environment"

    - name: Validate root directory structure
      run: |
        echo "üîç Validating repository root directory structure..."

        # Define allowed root files
        ALLOWED_FILES=(
          ".commitlintrc.json"
          ".flake8"
          ".gitignore"
          ".gitmessage"
          ".pre-commit-config.yaml"
          "adri-config.yaml"
          "ARCHITECTURE.md"
          "CHANGELOG.md"
          "CONTRIBUTING.md"
          "LICENSE"
          "NOTICE"
          "pyproject.toml"
          "README.md"
          "SECURITY.md"
          "TRADEMARK.md"
        )

        # Define allowed root directories
        ALLOWED_DIRS=(
          ".git"
          ".github"
          "ADRI"
          "archive"
          "demos"
          "docs"
          "examples"
          "scripts"
          "src"
          "tests"
        )

        # Check for unauthorized files in root (excluding temporary test artifacts)
        echo "üìÅ Checking for unauthorized files in root directory..."
        VIOLATIONS=0

        for file in *; do
          # Skip temporary test artifacts that might be created during parallel CI runs
          if [[ "$file" =~ ^(htmlcov|\.coverage.*|coverage\.(json|xml)|\.pytest_cache|\.benchmarks|.*_standard\.yaml|test_logs|bandit-report\.(json|xml)|\.tox|\.mypy_cache|\.hypothesis|.*\.tmp|.*\.temp|pip-.*\.log|build|dist|.*\.egg-info)$ ]]; then
            echo "‚è≠Ô∏è Skipping temporary artifact: $file"
            continue
          fi
          if [[ -f "$file" ]]; then
            # Check if file is in allowed list
            FOUND=0
            for allowed in "${ALLOWED_FILES[@]}"; do
              if [[ "$file" == "$allowed" ]]; then
                FOUND=1
                break
              fi
            done

            if [[ $FOUND -eq 0 ]]; then
              echo "‚ùå UNAUTHORIZED FILE: $file"
              echo "   Should be moved to appropriate directory:"

              # Suggest proper location based on file type
              case "$file" in
                *.md)
                  if [[ "$file" == *"plan"* || "$file" == *"implementation"* || "$file" == *"guide"* ]]; then
                    echo "   ‚Üí archive/internal-docs/ (internal documentation)"
                  else
                    echo "   ‚Üí docs/ (user documentation)"
                  fi
                  ;;
                *.py)
                  echo "   ‚Üí tests/ (test files) or examples/ (example code)"
                  ;;
                *.json|*.xml|*.report)
                  echo "   ‚Üí Should be in .gitignore (build artifacts)"
                  ;;
                *.yaml|*.yml)
                  if [[ "$file" != "adri-config.yaml" ]]; then
                    echo "   ‚Üí examples/standards/ (data standards) or tests/fixtures/ (test data)"
                  fi
                  ;;
                *)
                  echo "   ‚Üí Check if this file should exist or be gitignored"
                  ;;
              esac
              VIOLATIONS=$((VIOLATIONS + 1))
            fi
          elif [[ -d "$file" ]]; then
            # Check if directory is in allowed list
            FOUND=0
            for allowed in "${ALLOWED_DIRS[@]}"; do
              if [[ "$file" == "$allowed" ]]; then
                FOUND=1
                break
              fi
            done

            if [[ $FOUND -eq 0 ]]; then
              echo "‚ùå UNAUTHORIZED DIRECTORY: $file"
              echo "   Consider if this should be:"
              echo "   ‚Üí Moved inside src/, tests/, docs/, or examples/"
              echo "   ‚Üí Added to .gitignore if it's a build artifact"
              echo "   ‚Üí Archived if it's legacy/internal content"
              VIOLATIONS=$((VIOLATIONS + 1))
            fi
          fi
        done

        # Report results
        if [[ $VIOLATIONS -eq 0 ]]; then
          echo "‚úÖ Root directory structure is clean and compliant!"
          echo ""
          echo "üìä Current root structure:"
          ls -la | grep -E "^(d|-)" | awk '{print "   " $9}' | grep -v "^\.$" | grep -v "^\.\.$$"
        else
          echo ""
          echo "‚ùå Found $VIOLATIONS structure violations!"
          echo ""
          echo "üìã Clean root directory policy:"
          echo "   ‚Ä¢ Documentation: README.md, CHANGELOG.md, CONTRIBUTING.md, etc."
          echo "   ‚Ä¢ Configuration: pyproject.toml, .gitignore, .pre-commit-config.yaml"
          echo "   ‚Ä¢ Source directories: src/, tests/, docs/, examples/, demos/"
          echo "   ‚Ä¢ NO: Planning docs, build artifacts, temp files, AI-generated files"
          echo ""
          echo "üõ†Ô∏è  To fix violations:"
          echo "   1. Move files to appropriate directories (see suggestions above)"
          echo "   2. Add build artifacts to .gitignore"
          echo "   3. Archive internal documentation to archive/internal-docs/"
          echo ""
          exit 1
        fi

  validate-gitignore-protection:
    runs-on: ubuntu-latest
    needs: [test, security, build-test]
    if: always()  # Run even if other jobs had issues

    steps:
    - uses: actions/checkout@v4

    - name: Validate .gitignore protections
      run: |
        echo "üõ°Ô∏è Validating .gitignore protection patterns..."

        # Required protection patterns
        REQUIRED_PATTERNS=(
          "archive/"
          "src/adri/_version.py"
          "*_plan.md"
          "*_implementation*.md"
          "*.DS_Store"
          "*.swp"
          "bandit-report.json"
          "coverage.xml"
          "dist/"
          "build/"
          "*.egg-info/"
        )

        MISSING_PATTERNS=()

        for pattern in "${REQUIRED_PATTERNS[@]}"; do
          if ! grep -qF "$pattern" .gitignore; then
            MISSING_PATTERNS+=("$pattern")
          fi
        done

        if [[ ${#MISSING_PATTERNS[@]} -eq 0 ]]; then
          echo "‚úÖ All required protection patterns are present in .gitignore"
        else
          echo "‚ùå Missing required .gitignore patterns:"
          for pattern in "${MISSING_PATTERNS[@]}"; do
            echo "   - $pattern"
          done
          echo ""
          echo "These patterns help prevent accidental publication of:"
          echo "   ‚Ä¢ Build artifacts and temporary files"
          echo "   ‚Ä¢ AI-generated planning documents"
          echo "   ‚Ä¢ System files and caches"
          echo "   ‚Ä¢ Internal development artifacts"
          exit 1
        fi
